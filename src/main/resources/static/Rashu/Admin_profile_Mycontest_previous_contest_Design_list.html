<html>
    <head>
    <title>
        Contest Design list for admin
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="Admin_profile_body_background.css">
    <link rel="stylesheet" href="Admin_profile_menu-bar.css">
    <link rel="stylesheet" href="Admin_profile_main-content.css">
    <link rel="stylesheet" href="Admin_profile_form.css">
    <link rel="stylesheet" href="Pagination.css">
    <link rel="stylesheet" href="Admin_profile_display_table.css">
    <link rel="stylesheet" href="Admin_profile_footer.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <style>

            .profile {
                text-align: center;
                padding: 20px;
                border: 1px solid #ddd;
                border-radius: 10px;
                width: 550px;
                margin: 5px auto;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                background-color: #f9f9f9;
                color:#333;
            }

            .profile p {
                font-size: 18px;
                margin: 10px 0;
            }

            .profile p:first-child {
                font-weight: bold;
                color: #333;
            }
            .profile p:not(:first-child) {
                color: #555;
            }

             #designList div {
                 margin-bottom: 20px;
             }

            #searchInput {
                padding: 8px;
                width: 300px;
            }

            #searchButton, #resetButton {
                padding: 8px 12px;
                margin-left: 10px;
                cursor: pointer;
                font-size: 14px;
            }


            #searchButton {
                background-color: #4CAF50;
                max-width: fit-content;
                color: white;
                border: none;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #333;
            }

            #resetButton {
                background-color: #f44336;
                max-width: fit-content;
                color: white;
                border: none;
            }


            #searchButton:hover, #resetButton:hover {
                opacity: 0.8;
            }


        </style>
    </head>
    <body>
            <header>
                <div class="backgrounding">
                    <div class="menubar">
                        <img src="design_logo_02.jpg" class="logo">
                        <ul style="color:white; padding: 5px;" >

                            <li><i class="fas fa-user-circle" style="color: white;"></i><span style="color:white; padding: 5px" id="adminName"> </span></li>
                        </ul>
                    </div>
                </div>
             </header>
    
        <main class="content_main">
            <div class="menu-bar">
            <ul>
                <li><a href="/home"><i class="fa fa-home "></i> Home</a></li>
                <li><a href="Admin_profile_my_profile.html"><i class="fa fa-user "></i> My profile</a></li>
                <li><a href="Admin_profile_Designs.html"><i class="fas fa-list-ul "></i> Designs</a>

                </li>
                
                <li><a href="Admin_profile_Designers.html"><i class="fa fa-users"></i> Designers</a></li>
                <li><a href="Admin_profile_Users.html"><i class="fa fa-users"></i> Users</a></li>
                <li><a href="Admin_profile_Users.html"><i class="fa fa-users"></i> Admins</a></li>
                <li class="active" ><a ><i class="fas fa-trophy contest-icon "></i> My contest</a>
                    <div class="sub-menu-2">
                        <ul>
                            <li><a href="Admin_profile_Mycontest_contest_request.html">Contest Requests</a></li>
                            <li><a>Previous Contest</a></li>
                            <li><a href="Admin_profile_Mycontest_Set_A_Contest.html">Set A Contest</a></li>
                        </ul>
                    </div>
                </li>
                <li><a href="Admin_profile_Inbox.html"><i class="fas fa-inbox inbox-icon"></i> Inbox</a></li>
                <li ><a ><i class="fas fa-bullhorn announcement-icon "></i> Announcements</a>
                    <div class="sub-menu-2">
                        <ul>
                            <li><a href="Admin_profile_Announcement_previous_announcement.html">Previous Announcement</a></li>
                            <li><a href="Admin_profile_Announcement_Set_an__announcement.html">Set An Announcement</a></li>
                        </ul>
                    </div>
                </li>
                
                <li><a ><i class="fas fa-cog profile-settings-icon "></i> Profile Setting</a>
                    <div class="sub-menu-2">
                        <ul>
                            <li><a href="Admin_profile_Edit_Profile_update_details.html">Update Details</a></li>
                            <li><a href="Admin_profile_Edit_Profile_Change_password.html">Change Password</a></li>

                        </ul>
                    </div>
                </li>
                <li onclick="logout()"><a href="" ><i class="fas fa-sign-out-alt"></i> Logout</a></li>

            </ul>
            </div>

            <div class="main-content">
                <h3>Contest Information</h3>
                <div class="profile" id="contestInfo">

                </div>
                <h1>Submitted Design List</h1>
                <div id="designsList">

                    <table>
                        <tr>
                            <th>Designer Name</th>
                            <th>Design Title</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>

                    </table>
                    <div id="pagination">
                        <button id="prevButton">Previous</button>
                        <button id="nextButton">Next</button>
                    </div>
                </div>
            </div>
        </main>
            <footer class="footer">
                <div class="container_ftr">
                    <div class="row">
                        <div class="footer-col">
                            <ul>
                                <li>&copy; COPYRIGHT Reserved by</li>
                                <li>Digital Art Design </li>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <ul>
                                <div class="contact">
                                    <li>Contact Information:</li>
                                    <li>Address: Chittagong, Bangladesh</li>
                                    <li>Phone: <a href="tel:+15551234567">(555) 123-4567</a></li>
                                    <li>Email: <a href="mailto:info@example.com">info@example.com</a></li>
                                </div>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <h4>Help</h4>
                            <ul>
                                <li><a href="Admin_profile_About_Us.html">about us</a></li>
                                <li><a href="Admin_profile_Our_Services.html">our services</a></li>
                                <li><a href="Admin_profile_FAQ.html">FAQ</a></li>
                            </ul>
                        </div>
                        <div class="footer-col">
                            <h4>follow us</h4>
                            <div class="social-links">
                                <a ><i class="fab fa-facebook-f"></i></a>
                                <a ><i class="fab fa-twitter"></i></a>
                                <a ><i class="fab fa-instagram"></i></a>
                                <a ><i class="fab fa-linkedin-in"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
            <script>

                function logout() {
                    sessionStorage.removeItem("Admin_id"); // Remove the Admin_id from session storage
                    window.location.href = "/home";
                }
                function checkAdminId() {
                    let id = sessionStorage.getItem("Admin_id");
                    if (id === null) {
                        window.location.href = "/home";
                        return null; // Return null if Admin_id is null
                    }
                    return id; // Return Admin_id if it exists
                }

                document.addEventListener("DOMContentLoaded", function () {
                    const id = checkAdminId();

                    const contestId = sessionStorage.getItem('contest_id');
                    const admin_nameContainer = document.getElementById("adminName");

                    const Admin_Name = sessionStorage.getItem('Admin_Name');
                    console.log(Admin_Name);
                    admin_nameContainer.innerHTML = Admin_Name;

                    const designsList = document.getElementById("designsList");
                    const table = designsList.querySelector("table");


                    const contestInfo = document.getElementById("contestInfo");


                    const itemsPerPage = 9;
                    let currentPage = 1;
                    let designs;
                    let contestData;


                    function fetchDesignData(contestId) {
                        return fetch(`/Rashu_seeContestDesigns?contestId=${contestId}`)
                            .then(response => response.json())
                            .then(data => {
                                designs = data;
                                return data;
                            })
                            .catch(error => {
                                console.error('Error fetching design data:', error);
                                throw error;
                            });
                    }


                    function fetchContestData(contestId) {
                        return fetch(`/Rashu_contest?contestId=${contestId}`)
                            .then(response => response.json())
                            .then(data => {
                                contestData = data;
                                return data;
                            })
                            .catch(error => {
                                console.error('Error fetching contest data:', error);
                                throw error;
                            });
                    }


                    function displayContestDetails(contestData) {

                        contestInfo.innerHTML = `
                    <p>Contest Code: ${contestData.cnt_code}</p>
                    <p>Title: ${contestData.cnt_Title}</p>
                    <p>Description: ${contestData.description}</p>
                    <p>Starting Date: ${contestData.start}</p>
                    <p>Last Date of Submission: ${contestData.last}</p>
                    <p>Maximum Submissions: ${contestData.mxS}</p>
                    <p>Total Submission: ${designs.length}</p>
                    <!-- Add more contest details as needed -->
                `;
                    }


                    function displayDesigns(designs, page) {

                        while (table.rows.length > 1) {
                            table.deleteRow(1);
                        }

                        const startIndex = (page - 1) * itemsPerPage;
                        const endIndex = page * itemsPerPage;

                        function updateSelectionOnServer(includedInObject, selection) {
                            // Create the request payload
                            const requestData = {
                                includedIn: includedInObject,
                                selection: selection
                            };


                            fetch('/api/included-in/update-selection', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(requestData),
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! Status: ${response.status}`);
                                    } else {
                                        location.reload();
                                    }

                                })
                                .catch(error => {
                                    console.error('Error updating selection:', error);
                                });
                        }

                        for (let i = startIndex; i < endIndex && i < designs.length; i++) {
                            const Design = designs[i];
                            const row = table.insertRow();
                            const cell1 = row.insertCell(0);
                            cell1.style.width = "125px";
                            const cell2 = row.insertCell(1);
                            cell2.style.width = "100px";
                            const cell3 = row.insertCell(2);
                            cell3.style.width = "150px";
                            const cell4 = row.insertCell(3);
                            cell4.style.width = "150px";
                            console.log(Design);
                            cell1.innerHTML = Design.design.designer.name;
                            cell2.innerHTML = Design.design.title + '<br>' + getStatusText(Design.selection);

                            function getStatusText(selection) {
                                if (selection === 0) {
                                    return '<span style="color: deepskyblue;"><strong>Status: Pending</strong></span>';
                                } else if (selection === 1) {
                                    return '<span style="color: green;"><strong>Status: Selected</strong></span>';
                                } else if (selection === 2) {
                                    return '<span style="color: red;"><strong>Status: Not Selected</strong></span>';
                                } else {
                                    return '<span style="color: blue;"><strong>Unknown Status</strong></span>';
                                }
                            }

                            cell3.innerHTML = Design.design.description;


                            const imageContainer = document.createElement("div");
                            cell4.appendChild(imageContainer);

                            const previewImage = document.createElement("img");
                            console.log("3  " + Design.design.content);


                            const binaryString = atob(Design.design.content);
                            const contentArray = new Uint8Array(binaryString.length);
                            for (let i = 0; i < binaryString.length; i++) {
                                contentArray[i] = binaryString.charCodeAt(i);
                            }


                            const blob = new Blob([contentArray]);


                            const fileReader = new FileReader();
                            fileReader.onload = function (event) {
                                const arrayBuffer = event.target.result;
                                const uint8Array = new Uint8Array(arrayBuffer);


                                const detectedType = getImageType(uint8Array);


                                if (detectedType) {

                                    const blob = new Blob([contentArray], {type: detectedType.mime});


                                    const dataUrl = URL.createObjectURL(blob);


                                    previewImage.src = dataUrl;


                                    previewImage.width = 300;
                                    previewImage.height = 260;


                                    imageContainer.appendChild(previewImage);


                                    const selectButton = document.createElement("button");
                                    selectButton.textContent = "Select";
                                    selectButton.classList.add("select");
                                    selectButton.style.width = "75px";
                                    selectButton.style.fontSize = "12px";
                                    selectButton.style.padding = "5px";
                                    selectButton.addEventListener("click", function () {

                                        updateSelectionOnServer(Design, 1);

                                    });
                                    cell4.appendChild(selectButton);


                                    const unselectButton = document.createElement("button");
                                    unselectButton.textContent = "Not select";
                                    unselectButton.classList.add("unselect");
                                    unselectButton.style.width = "75px";
                                    unselectButton.style.fontSize = "12px";
                                    unselectButton.style.padding = "5px";
                                    unselectButton.addEventListener("click", function () {

                                        updateSelectionOnServer(Design, 2);

                                    });
                                    cell4.appendChild(unselectButton);

                                    const pendingButton = document.createElement("button");
                                    pendingButton.textContent = "pending";
                                    pendingButton.classList.add("pending");
                                    pendingButton.style.width = "75px";
                                    pendingButton.style.fontSize = "12px";
                                    pendingButton.style.padding = "5px";
                                    pendingButton.addEventListener("click", function () {


                                        updateSelectionOnServer(Design, 0);

                                    });
                                    cell4.appendChild(pendingButton);

                                } else {
                                    console.error('Unable to determine image type.');
                                }
                            };


                            fileReader.readAsArrayBuffer(blob);
                        }

                        function getImageType(uint8Array) {
                            const headerBytes = uint8Array.subarray(0, 4);


                            if (headerBytes[0] === 0xFF && headerBytes[1] === 0xD8 && headerBytes[2] === 0xFF && headerBytes[3] === 0xE0) {
                                return {mime: 'image/jpeg'};
                            }


                            if (headerBytes[0] === 0x89 && headerBytes[1] === 0x50 && headerBytes[2] === 0x4E && headerBytes[3] === 0x47) {
                                return {mime: 'image/png'};
                            }


                            if (headerBytes[0] === 0x47 && headerBytes[1] === 0x49 && headerBytes[2] === 0x46 && headerBytes[3] === 0x38) {
                                return {mime: 'image/gif'};
                            }


                            if (headerBytes[0] === 0xFF && headerBytes[1] === 0xD8 && headerBytes[2] === 0xFF && headerBytes[3] === 0xDB) {
                                return {mime: 'image/jpeg'};
                            }

                            if (headerBytes[0] === 0xFF && headerBytes[1] === 0xD8 && headerBytes[2] === 0xFF && headerBytes[3] === 0xE1) {
                                return {mime: 'image/jpeg'};
                            }

                            if (headerBytes[0] === 0x52 && headerBytes[1] === 0x49 && headerBytes[2] === 0x46 && headerBytes[3] === 0x46) {
                                return { mime: 'image/webp' };
                            }
                            return null;
                        }
                    }


                    Promise.all([fetchDesignData(contestId), fetchContestData(contestId)])
                        .then(([designsData, contestData]) => {

                            displayContestDetails(contestData);
                            displayDesigns(designsData, currentPage);
                        })
                        .catch(error => {

                            console.error('Error:', error);
                        });


                    document.getElementById("nextButton").addEventListener("click", function () {
                        if (designs && currentPage < Math.ceil(designs.length / itemsPerPage)) {
                            currentPage++;
                            displayDesigns(designs, currentPage);
                        }
                    });


                    document.getElementById("prevButton").addEventListener("click", function () {
                        if (designs && currentPage > 1) {
                            currentPage--;
                            displayDesigns(designs, currentPage);
                        }
                    });
                });

                window.addEventListener("beforeunload", function(event) {
                    const id = sessionStorage.getItem("Admin_id");
                    if (id === null) {
                        sessionStorage.removeItem("Admin_id");
                    }
                });

            </script>

    </body>
</html>
